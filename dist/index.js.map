{"version":3,"sources":["../src/index.ts","../src/instrumentation.ts","../src/transport.ts","../src/payload/QrynPayload.ts","../src/payload/transform/transform.ts","../src/payload/config/config.ts","../src/payload/transform/utils.ts"],"sourcesContent":["export { TracingInstrumentation } from './instrumentation'\nexport { QrynTransport } from './transport'\nexport type { QrynLokiTransportOptions, QrynLokiTransportRequestOptions } from './types'\n","import { BaseInstrumentation } from '@grafana/faro-core'\nimport { context, trace } from '@opentelemetry/api'\nimport { ZoneContextManager } from '@opentelemetry/context-zone'\nimport { W3CTraceContextPropagator } from '@opentelemetry/core'\nimport { ZipkinExporter } from '@opentelemetry/exporter-zipkin'\nimport { registerInstrumentations } from '@opentelemetry/instrumentation'\nimport { DocumentLoadInstrumentation } from '@opentelemetry/instrumentation-document-load'\nimport { FetchInstrumentation } from '@opentelemetry/instrumentation-fetch'\nimport { UserInteractionInstrumentation } from '@opentelemetry/instrumentation-user-interaction'\nimport { XMLHttpRequestInstrumentation } from '@opentelemetry/instrumentation-xml-http-request'\nimport { Resource, type ResourceAttributes } from '@opentelemetry/resources'\nimport { BatchSpanProcessor, WebTracerProvider } from '@opentelemetry/sdk-trace-web'\nimport { SemanticResourceAttributes } from '@opentelemetry/semantic-conventions'\n\nimport { type TracingInstrumentationOptions } from './types'\n\nexport class TracingInstrumentation extends BaseInstrumentation {\n  name = '@gigapipe/faro-web-tracing-zipkin'\n\n  version = '1.0.0'\n\n  static SCHEDULED_BATCH_DELAY_MS = 1000\n\n  static MAX_EXPORT_BATCH_SIZE = 30\n\n  constructor(private options: TracingInstrumentationOptions) {\n    super()\n  }\n\n  initialize(): void {\n    const { options } = this\n    const attributes: ResourceAttributes = {}\n\n    if (this.config.app.name) {\n      attributes[SemanticResourceAttributes.SERVICE_NAME] = this.config.app.name\n    }\n\n    if (this.config.app.version) {\n      attributes[SemanticResourceAttributes.SERVICE_VERSION] = this.config.app.version\n    }\n\n    Object.assign(attributes, options.resourceAttributes)\n\n    const resource = Resource.default().merge(new Resource(attributes))\n\n    const provider = new WebTracerProvider({ resource })\n\n    provider.addSpanProcessor(\n      new BatchSpanProcessor(\n        new ZipkinExporter({\n          headers: { 'x-api-token': this.options.apiToken },\n          url: `${this.options.host}/tempo/spans`,\n          serviceName: this.config.app.name,\n        }),\n        {\n          scheduledDelayMillis: TracingInstrumentation.SCHEDULED_BATCH_DELAY_MS,\n          maxExportBatchSize: TracingInstrumentation.MAX_EXPORT_BATCH_SIZE,\n        },\n      ),\n    )\n\n    provider.register({\n      propagator: options.propagator ?? new W3CTraceContextPropagator(),\n      contextManager: options.contextManager ?? new ZoneContextManager(),\n    })\n\n    registerInstrumentations({\n      instrumentations: options.instrumentations ?? [\n        new DocumentLoadInstrumentation(),\n        new FetchInstrumentation({\n          ignoreUrls: this.getIgnoreUrls(),\n          propagateTraceHeaderCorsUrls:\n            this.options.instrumentationOptions?.propagateTraceHeaderCorsUrls,\n        }),\n        new XMLHttpRequestInstrumentation({\n          ignoreUrls: this.getIgnoreUrls(),\n          propagateTraceHeaderCorsUrls:\n            this.options.instrumentationOptions?.propagateTraceHeaderCorsUrls,\n        }),\n        new UserInteractionInstrumentation(),\n      ],\n    })\n\n    this.api.initOTEL(trace, context)\n  }\n\n  private getIgnoreUrls(): Array<string | RegExp> {\n    return this.transports.transports.flatMap(transport => transport.getIgnoreUrls())\n  }\n}\n","/* eslint-disable no-restricted-syntax */\nimport {\n  BaseTransport,\n  createPromiseBuffer,\n  type PromiseBuffer,\n  type TransportItem as FaroTransportItem,\n} from '@grafana/faro-core'\n\nimport { QrynPayload, type QrynTransportPayload } from './payload'\nimport { type GetLabelsFromMeta, TransportItem } from './payload/transform'\nimport type { QrynLokiTransportOptions } from './types'\n\nconst DEFAULT_BUFFER_SIZE = 30\nconst DEFAULT_CONCURRENCY = 5 // chrome supports 10 total, firefox 17\nconst DEFAULT_RATE_LIMIT_BACKOFF_MS = 5000\nconst LOKI_LOGS_ENDPOINT = '/loki/api/v1/push'\nconst TEMPO_TRACES_ENDPOINT = '/v1/traces'\n\nexport class QrynTransport extends BaseTransport {\n  readonly name = '@gigapipe/faro-transport-qryn'\n\n  readonly version = '1.0.0'\n\n  private readonly promiseBuffer: PromiseBuffer<Response | void>\n\n  private readonly rateLimitBackoffMs: number\n\n  private readonly getNow: () => number\n\n  private sendingTracesDisabledUntil: Date = new Date()\n\n  private sendingLogsDisabledUntil: Date = new Date()\n\n  private logsURL: string\n\n  private tracesURL: string\n\n  private getLabelsFromMeta?: GetLabelsFromMeta\n\n  constructor(private options: QrynLokiTransportOptions) {\n    super()\n    this.rateLimitBackoffMs = options.defaultRateLimitBackoffMs ?? DEFAULT_RATE_LIMIT_BACKOFF_MS\n    this.getNow = options.getNow ?? (() => Date.now())\n\n    // TODO: make this configurable through an option that controls the prefered ingestion API for each signal\n    this.logsURL = `${options.host}${LOKI_LOGS_ENDPOINT}`\n    this.tracesURL = `${options.host}${TEMPO_TRACES_ENDPOINT}`\n\n    this.getLabelsFromMeta = options.getLabelsFromMeta\n\n    this.promiseBuffer = createPromiseBuffer({\n      size: options.bufferSize ?? DEFAULT_BUFFER_SIZE,\n      concurrency: options.concurrency ?? DEFAULT_CONCURRENCY,\n    })\n  }\n\n  send(item: FaroTransportItem | FaroTransportItem[]): void {\n    this.logDebug(`Sending item: ${JSON.stringify(item)}`)\n    const qrynPayload = new QrynPayload(this.internalLogger, this.getLabelsFromMeta)\n    const items = Array.isArray(item) ? item : [item]\n\n    items.forEach(i => qrynPayload.addResourceItem(i as TransportItem))\n    this.logDebug('Current QrynPayload:', qrynPayload)\n    this.sendPayload(qrynPayload.getPayload())\n  }\n\n  private sendPayload(payload: QrynTransportPayload): void {\n    try {\n      for (const [key, value] of Object.entries(payload)) {\n        if (!QrynPayload.hasPayload(value)) {\n          this.logWarn(`Dropping transport item due to missing payload: ${JSON.stringify(value)}`)\n          // eslint-disable-next-line no-continue\n          continue\n        }\n\n        let disabledUntil: Date | undefined\n        let updateDisabledUntil = (_: Date) => {}\n        let url = ''\n\n        switch (key) {\n          case 'resourceSpans':\n            url = this.tracesURL\n            disabledUntil = this.sendingTracesDisabledUntil\n\n            updateDisabledUntil = (retryAfterDate: Date) => {\n              this.sendingTracesDisabledUntil = retryAfterDate\n            }\n            break\n          case 'resourceLogs':\n            url = this.logsURL\n            disabledUntil = this.sendingLogsDisabledUntil\n            updateDisabledUntil = (retryAfterDate: Date) => {\n              this.sendingLogsDisabledUntil = retryAfterDate\n            }\n            break\n          default:\n            break\n        }\n\n        if (disabledUntil && disabledUntil > new Date(Date.now())) {\n          this.logWarn(\n            `Dropping transport item due to too many requests. Backoff until ${disabledUntil}`,\n          )\n          return undefined\n        }\n        this.logDebug(`Sending value: ${JSON.stringify(value)}`, `to ${url}`)\n\n        const body = JSON.stringify(value)\n\n        const { requestOptions, apiToken } = this.options\n        const { headers, ...restOfRequestOptions } = requestOptions ?? {}\n\n        this.promiseBuffer.add(() =>\n          fetch(url, {\n            method: 'POST',\n            headers: {\n              'Content-Type': 'application/json',\n              'x-api-token': apiToken,\n              ...(headers ?? {}),\n            },\n            body,\n            keepalive: true,\n            ...(restOfRequestOptions ?? {}),\n          })\n            .then(response => {\n              if (response.status === 429) {\n                updateDisabledUntil(this.getRetryAfterDate(response))\n                this.logWarn(`Too many requests, backing off until ${disabledUntil}`)\n              }\n\n              return response\n            })\n            .catch(error => {\n              this.logError('Failed sending payload to the receiver\\n', JSON.parse(body), error)\n            }),\n        )\n      }\n    } catch (error) {\n      this.logError(error)\n    }\n  }\n\n  override getIgnoreUrls(): Array<string | RegExp> {\n    const { tracesURL, logsURL } = this\n    return [tracesURL, logsURL].filter(Boolean)\n  }\n\n  private getRetryAfterDate(response: Response): Date {\n    const now = Date.now()\n    const retryAfterHeader = response.headers.get('Retry-After')\n\n    if (retryAfterHeader) {\n      const delay = Number(retryAfterHeader)\n\n      if (!Number.isNaN(delay)) {\n        return new Date(delay * 1000 + now)\n      }\n\n      const date = Date.parse(retryAfterHeader)\n\n      if (!Number.isNaN(date)) {\n        return new Date(date)\n      }\n    }\n\n    return new Date(now + this.rateLimitBackoffMs)\n  }\n}\n","import { type InternalLogger, TransportItemType } from '@grafana/faro-core'\nimport compare from 'just-compare'\n\nimport {\n  type GetLabelsFromMeta,\n  getLogTransforms,\n  getTraceTransforms,\n  type LogsTransform,\n  type TraceTransform,\n  TransportItem,\n} from './transform'\nimport type { QrynTransportPayload } from './types'\n\nexport class QrynPayload {\n  private resourceLogs = { streams: [] } as QrynTransportPayload['resourceLogs']\n\n  private resourceSpans = [] as QrynTransportPayload['resourceSpans']\n\n  private getLogTransforms: LogsTransform\n\n  private getTraceTransforms: TraceTransform\n\n  constructor(\n    private internalLogger: InternalLogger,\n    getLabelsFromMeta?: GetLabelsFromMeta,\n    transportItem?: TransportItem,\n  ) {\n    this.internalLogger = internalLogger\n\n    this.getLogTransforms = getLogTransforms(this.internalLogger, getLabelsFromMeta)\n    this.getTraceTransforms = getTraceTransforms(this.internalLogger)\n\n    if (transportItem) {\n      this.addResourceItem(transportItem)\n    }\n  }\n\n  getPayload(): QrynTransportPayload {\n    return {\n      resourceLogs: this.resourceLogs,\n      resourceSpans: this.resourceSpans,\n    } as const\n  }\n\n  addResourceItem(transportItem: TransportItem): void {\n    const { type } = transportItem\n\n    try {\n      switch (type) {\n        case TransportItemType.LOG:\n        case TransportItemType.EXCEPTION:\n        case TransportItemType.EVENT:\n        case TransportItemType.MEASUREMENT: {\n          const { toLogValue, toLogLabels } = this.getLogTransforms\n\n          const currentLogStream = toLogLabels(transportItem)\n\n          const existingResourceLogs = this.resourceLogs.streams.find(({ stream }) =>\n            compare(stream, currentLogStream),\n          )\n\n          if (existingResourceLogs) {\n            // Push the transportItem to the existing resource log\n            const logValue = toLogValue(transportItem)\n            if (logValue) existingResourceLogs.values.push(logValue)\n          } else {\n            // Push the transportItem to a new resource log\n            const logLabels = toLogLabels(transportItem)\n            const logValue = toLogValue(transportItem)\n\n            if (logLabels && logValue)\n              this.resourceLogs.streams.push({ stream: logLabels, values: [logValue] })\n          }\n\n          break\n        }\n        case TransportItemType.TRACE: {\n          // A the moment we can only use the `/tempo/spans` endpoint which accepts only ReadableSpan[]\n          // As a workaround we have created a custom TracingInstrumentation that uses the Zipkin exporter to directly push spans to that endpoint overruling Faro API.\n          // In order to use a single transport qryn should support the OTLP API `/v1/traces`\n          break\n        }\n        default:\n          this.internalLogger?.error(`Unknown TransportItemType: ${type}`)\n          break\n      }\n    } catch (error) {\n      this.internalLogger?.error(error)\n    }\n  }\n\n  static hasPayload(value: any): boolean {\n    if (value && value.streams && value.streams.length > 0) {\n      return true\n    }\n    if (Array.isArray(value) && value.length > 0) {\n      return true\n    }\n    return false\n  }\n}\n","/* eslint-disable consistent-return */\nimport {\n  EventEvent,\n  ExceptionEvent,\n  InternalLogger,\n  LogEvent,\n  LogLevel,\n  MeasurementEvent,\n  TransportItem,\n  TransportItemType,\n} from '@grafana/faro-core'\n\nimport { defaultLabels } from '../config'\nimport type {\n  GetLabelsFromMeta,\n  LogsTransform,\n  LogTransportItem,\n  LogValue,\n  TraceTransportItem,\n} from './types'\nimport { fmt } from './utils'\n\nexport function getLogTransforms(\n  internalLogger: InternalLogger,\n  getLabelsFromMeta: GetLabelsFromMeta = defaultLabels,\n): LogsTransform {\n  function toLogLogValue(payload: TransportItem<LogEvent>['payload']): LogValue {\n    const { timestamp, trace, message, context } = payload\n    const timeUnixNano = toTimeUnixNano(timestamp)\n\n    return [\n      timeUnixNano.toString(),\n      fmt.stringify({\n        message,\n        context: JSON.stringify(context),\n        ...(trace && { traceId: trace.trace_id }),\n      }),\n    ]\n  }\n\n  function toErrorLogValue(payload: TransportItem<ExceptionEvent>['payload']): LogValue {\n    const { timestamp, trace, type, value, stacktrace } = payload\n    const timeUnixNano = toTimeUnixNano(timestamp)\n\n    return [\n      timeUnixNano.toString(),\n      fmt.stringify({\n        type,\n        value,\n        stacktrace: JSON.stringify(stacktrace),\n        ...(trace && { traceId: trace.trace_id }),\n      }),\n    ]\n  }\n\n  function toEventLogValue(payload: TransportItem<EventEvent>['payload']): LogValue {\n    const { timestamp, trace, name, attributes, domain } = payload\n    const timeUnixNano = toTimeUnixNano(timestamp)\n\n    return [\n      timeUnixNano.toString(),\n      fmt.stringify({\n        name,\n        attributes: JSON.stringify(attributes),\n        ...(domain && { domain }),\n        ...(trace && { traceId: trace.trace_id }),\n      }),\n    ]\n  }\n\n  function toMeasurementLogValue(payload: TransportItem<MeasurementEvent>['payload']): LogValue {\n    const { timestamp, trace, type, values } = payload\n    const timeUnixNano = toTimeUnixNano(timestamp)\n\n    return [\n      timeUnixNano.toString(),\n      fmt.stringify({\n        type,\n        values: JSON.stringify(values),\n        ...(trace && { traceId: trace.trace_id }),\n      }),\n    ]\n  }\n\n  function toLogValue(transportItem: LogTransportItem) {\n    const { type, payload } = transportItem\n    switch (type) {\n      case TransportItemType.LOG:\n        return toLogLogValue(payload)\n      case TransportItemType.EXCEPTION:\n        return toErrorLogValue(payload)\n      case TransportItemType.EVENT:\n        return toEventLogValue(payload)\n      case TransportItemType.MEASUREMENT:\n        return toMeasurementLogValue(payload)\n      default:\n        internalLogger?.error(`Unknown TransportItemType: ${type}`)\n        return undefined\n    }\n  }\n\n  function toLogLabels(transportItem: LogTransportItem) {\n    const { type, payload, meta } = transportItem\n    switch (type) {\n      case TransportItemType.LOG:\n        return {\n          level: payload.level,\n          ...getLabelsFromMeta(meta),\n        }\n      case TransportItemType.EXCEPTION:\n        return {\n          level: LogLevel.ERROR,\n          ...getLabelsFromMeta(meta),\n        }\n      case TransportItemType.EVENT:\n        return {\n          level: LogLevel.INFO,\n          ...getLabelsFromMeta(meta),\n        }\n      case TransportItemType.MEASUREMENT:\n        return {\n          level: LogLevel.INFO,\n          ...getLabelsFromMeta(meta),\n        }\n      default:\n        internalLogger?.error(`Unknown TransportItemType: ${type}`)\n        return undefined\n    }\n  }\n\n  function toTimeUnixNano(timestamp: string): number {\n    return Date.parse(timestamp) * 1e6\n  }\n\n  return { toLogValue, toLogLabels }\n}\n\nexport function getTraceTransforms(internalLogger: InternalLogger) {\n  function toSpanValue(transportItem: TraceTransportItem): undefined {\n    const { type } = transportItem\n    switch (type) {\n      case TransportItemType.TRACE:\n        return undefined\n\n      default:\n        internalLogger?.error(`Unknown TransportItemType: ${type}`)\n        return undefined\n    }\n  }\n  return { toSpanValue }\n}\n","import { Meta } from '@grafana/faro-core'\n\nexport function defaultLabels(meta: Meta) {\n  return {\n    ...(meta.app && {\n      app: meta.app.name,\n      environment: meta.app.environment,\n      release: meta.app.release,\n    }),\n    ...(meta.browser && { browser_name: meta.browser.name }),\n    ...(meta.user && { user_id: meta.user.id }),\n  }\n}\n","function stringify(data: Record<string, string | number>) {\n  let line = ''\n\n  Object.keys(data).forEach(key => {\n    let value = ''\n    let isNull = false\n\n    if (data[key] == null) {\n      isNull = true\n      value = ''\n    } else {\n      value = data[key].toString()\n    }\n\n    const needsQuoting = value.indexOf(' ') > -1 || value.indexOf('=') > -1\n    const needsEscaping = value.indexOf('\"') > -1 || value.indexOf('\\\\') > -1\n\n    if (needsEscaping) value = value.replace(/[\"\\\\]/g, '\\\\$&')\n    if (needsQuoting) value = `\"${value}\"`\n    if (value === '' && !isNull) value = '\"\"'\n\n    line += `${key}=${value} `\n  })\n\n  return line.substring(0, line.length - 1)\n}\n\nexport const fmt = {\n  stringify,\n}\n"],"mappings":"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","names":["import_faro_core","import_faro_core","import_faro_core","trace","context","compare"]}